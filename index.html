<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Stock C√¢bles - Magasin</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Custom Cursor -->
    <div class="cursor"></div>
    <div class="cursor-follower"></div>

    <!-- Particles Canvas -->
    <canvas id="particles"></canvas>

    <!-- Protection de s√©curit√© -->
    <script>
        if (sessionStorage.getItem('authenticated') !== 'true') {
            window.location.href = 'login.html';
        }
        
        const loginTime = sessionStorage.getItem('loginTime');
        const currentTime = new Date().getTime();
        const eightHours = 8 * 60 * 60 * 1000;
        
        if (loginTime && (currentTime - loginTime) > eightHours) {
            sessionStorage.removeItem('authenticated');
            sessionStorage.removeItem('loginTime');
            alert('Votre session a expir√©. Veuillez vous reconnecter.');
            window.location.href = 'login.html';
        }
    </script>
    
    <div class="app-container">
        <!-- Header -->
        <header class="main-header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">‚ö°</div>
                    <div class="logo-text">
                        <h1>Stock C√¢bles</h1>
                        <p>Gestion des tourets</p>
                    </div>
                </div>
                
                <div class="header-controls">
                    <div id="clock" class="clock-display">--:--:--</div>
                    <button id="themeToggle" class="icon-btn">üåô</button>
                    <button id="logoutBtn" class="icon-btn logout-btn" onclick="logout()">üö™</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="main-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" data-face="P">Face P</button>
                <button class="nav-tab" data-face="Q">Face Q</button>
                <button class="nav-tab" id="statsTab">üìä Statistiques</button>
            </div>
            
            <div class="nav-actions">
                <button id="addRangeBtn" class="action-btn primary">+ Ajouter Rang√©e</button>
                <button id="exportBtn" class="action-btn secondary" onclick="exportToCSV()">üì• Export CSV</button>
            </div>
        </nav>

        <!-- Search Bar -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="üîç Rechercher un c√¢ble, touret, rang√©e..." onkeyup="filterMaterials()">
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Stock View -->
            <div id="stockView" class="stock-view">
                <div id="stockContainer"></div>
            </div>

            <!-- Stats View -->
            <div id="statsView" class="stats-view" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-value" id="totalTourets">0</div>
                        <div class="stat-label">Total Tourets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="totalRanges">0</div>
                        <div class="stat-label">Total Rang√©es</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-value" id="lowStock">0</div>
                        <div class="stat-label">Stock Faible</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-value" id="lastUpdate">--:--</div>
                        <div class="stat-label">Derni√®re MAJ</div>
                    </div>
                </div>
                
                <div class="stats-details">
                    <h3>D√©tails par Face</h3>
                    <div id="faceDetails"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal pour √©diter/ajouter -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">√âditer</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nom</label>
                    <input type="text" id="editName" class="form-input">
                </div>
                <div class="form-group">
                    <label>Image (optionnel)</label>
                    <input type="file" id="editImage" accept="image/*" class="form-input">
                    <div id="imagePreview" class="image-preview"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Annuler</button>
                <button class="btn-save" onclick="saveEdit()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Fonction de d√©connexion -->
    <script>
        function logout() {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                sessionStorage.removeItem('authenticated');
                sessionStorage.removeItem('loginTime');
                window.location.href = 'login.html';
            }
        }
    </script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
      
      const firebaseConfig = {
        apiKey: "AIzaSyAiZIicItqSQ0kTaCnZu6xiJEgEt7l_nWw",
        authDomain: "magasin-462fb.firebaseapp.com",
        projectId: "magasin-462fb",
        storageBucket: "magasin-462fb.firebasestorage.app",
        messagingSenderId: "653350272436",
        appId: "1:653350272436:web:0c5f7c9481d3d7c98586e1"
      };
      
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      
      window.firebaseDB = db;
      window.firestoreCollection = collection;
      window.firestoreDoc = doc;
      window.firestoreGetDoc = getDoc;
      window.firestoreGetDocs = getDocs;
      window.firestoreSetDoc = setDoc;
      window.firestoreUpdateDoc = updateDoc;
      window.firestoreDeleteDoc = deleteDoc;
      window.firestoreOnSnapshot = onSnapshot;
      
      console.log("Firebase Firestore initialis√© !");
      
      import('./script.js');
    </script>

    <!-- Cursor & Particles Script -->
    <script>
        // Custom Cursor
        const cursor = document.querySelector('.cursor');
        const follower = document.querySelector('.cursor-follower');
        let mouseX = 0, mouseY = 0;
        let cursorX = 0, cursorY = 0;
        let followerX = 0, followerY = 0;

        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        function animateCursor() {
            const speed = 0.2;
            const followerSpeed = 0.12;

            cursorX += (mouseX - cursorX) * speed;
            cursorY += (mouseY - cursorY) * speed;

            followerX += (mouseX - followerX) * followerSpeed;
            followerY += (mouseY - followerY) * followerSpeed;

            cursor.style.transform = `translate(${cursorX}px, ${cursorY}px)`;
            follower.style.transform = `translate(${followerX - 16}px, ${followerY - 16}px)`;

            requestAnimationFrame(animateCursor);
        }

        animateCursor();

        // Cursor hover effects
        const hoverElements = document.querySelectorAll('button, a, input, .touret-item, .nav-tab, .action-btn');
        hoverElements.forEach(el => {
            el.addEventListener('mouseenter', () => {
                follower.classList.add('expand');
            });
            el.addEventListener('mouseleave', () => {
                follower.classList.remove('expand');
            });
        });

        // Particles
        const canvas = document.getElementById('particles');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const particles = [];
        const particleCount = 60;

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 1;
                this.speedX = (Math.random() - 0.5) * 0.6;
                this.speedY = (Math.random() - 0.5) * 0.6;
                this.opacity = Math.random() * 0.5 + 0.2;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                if (this.y < 0) this.y = canvas.height;
            }

            draw() {
                ctx.fillStyle = `rgba(0, 102, 255, ${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        for (let i = 0; i < particleCount; i++) {
            particles.push(new Particle());
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });

            // Connect particles
            particles.forEach((a, i) => {
                particles.slice(i + 1).forEach(b => {
                    const dx = a.x - b.x;
                    const dy = a.y - b.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 120) {
                        ctx.strokeStyle = `rgba(0, 102, 255, ${0.15 * (1 - distance / 120)})`;
                        ctx.lineWidth = 0.5;
                        ctx.beginPath();
                        ctx.moveTo(a.x, a.y);
                        ctx.lineTo(b.x, b.y);
                        ctx.stroke();
                    }
                });
            });

            requestAnimationFrame(animateParticles);
        }

        animateParticles();

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
